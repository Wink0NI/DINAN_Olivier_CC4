<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shortly - URL Shortner</title>
    <link rel="stylesheet" href="../public/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="page__title">
        <h1>Shortly</h1>
        <p>The minimalistic URL shortner</p>
      </div>
      <div class="short__form">
        <form class="shorten-form">
          <input type="text" name="url" id="url" placeholder="www.google.com" />
          <button class="btn btn-scissors"></button>
        </form>
      </div>

      <div class="content">
        <h2>URLs</h2>
      </div>
    </div>
    <script src="../public/index.js"></script>
    <script>
      const API_URL = "https://shortener-extra-f2ab66d60f80.herokuapp.com/api/shorten";

function copy(target) {
  // Element to select
  let copyText = target.closest(".shorten-url").children[0].innerText;
  navigator.clipboard.writeText(copyText);
}

document.addEventListener("click", (e) => {
  if (e.target.matches("span") && e.target.classList.contains("copyboard")) {
    copy(e.target);
  }
});

const content = document.querySelector(".content");

function putUrlOnThePage(url) {
  let shortenUrl = document.createElement("div");
  shortenUrl.classList.add("shorten-url");
  let urlLink = document.createElement("a");
  urlLink.classList.add("shorten-url-link");
  urlLink.href = url;
  urlLink.target = "_blank";
  urlLink.textContent = url;
  let copyboard = document.createElement("span");
  copyboard.classList.add("copyboard");

  shortenUrl.appendChild(urlLink);
  shortenUrl.appendChild(copyboard);

  content.appendChild(shortenUrl);
  content.classList.add("show");
}

const shortenForm = document.querySelector(".shorten-form");

shortenForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  let formData = new FormData(shortenForm);
  let url = formData.get("url").toString();
  let payload = { url };

  if (url.trim() == "" || !url.match(/https?:\/\//)) {
    return;
  }

  // Make request to API
  try {
    let request = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    });

    let response = await request.json();

    if (response.short) {
      putUrlOnThePage(response.short);
    } else {
      content.innerHTML = `<h2>${response.message}</h2>`;
    }
  } catch (err) {
    console.error(err);
  }
});

    </script>
  </body>
</html>
